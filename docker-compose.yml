version: "3.8"

services:
  # ============================================
  # MYSQL - Base de donnÃ©es
  # ============================================
  db:
    image: mysql:8.0
    restart: unless-stopped
    ports:
      - 3306
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=ghost
      - MYSQL_USER=ghost
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - db:/var/lib/mysql
    command:
      - --default-authentication-plugin=mysql_native_password
      - --max_allowed_packet=256M
      - --innodb_buffer_pool_size=512M
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "ghost", "-p${MYSQL_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # REDIS - Cache + Sessions + Jobs
  # ============================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - 6379
    volumes:
      - redis:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # GHOST - CMS (Image custom)
  # ============================================
  ghost:
    build:
      context: .
      dockerfile: Dockerfile.ghost
    image: ghost-advanced:6.0
    restart: unless-stopped
    ports:
      - 2368
    environment:
      # Core
      - url=https://${GHOST_HOST}
      - NODE_ENV=production
      
      # Database
      - database__client=mysql
      - database__connection__host=db
      - database__connection__user=ghost
      - database__connection__password=${MYSQL_PASSWORD}
      - database__connection__database=ghost
      
      # Redis (via config.production.json)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      
      # Mail
      - mail__transport=SMTP
      - mail__options__service=${MAIL_SERVICE:-Mailgun}
      - mail__options__host=${MAIL_HOST}
      - mail__options__port=${MAIL_PORT:-587}
      - mail__options__auth__user=${MAIL_USER}
      - mail__options__auth__pass=${MAIL_PASSWORD}
      - mail__from=${MAIL_FROM}
      
      # Cloudflare R2 (optionnel)
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      
    volumes:
      - ghost:/var/lib/ghost/content
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  ghost: {}
  db: {}
  redis: {}
