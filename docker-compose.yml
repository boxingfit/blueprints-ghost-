version: "3.8"

services:
  # ============================================
  # MYSQL - Base de donnÃ©es
  # ============================================
  db:
    image: mysql:8.0
    restart: unless-stopped
    ports:
      - 3306
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-changeme}
      - MYSQL_DATABASE=ghost
      - MYSQL_USER=ghost
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-changeme}
    volumes:
      - db:/var/lib/mysql
    command:
      - --default-authentication-plugin=mysql_native_password
      - --max_allowed_packet=256M
      - --innodb_buffer_pool_size=512M
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ============================================
  # REDIS - Cache + Sessions
  # ============================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - 6379
    volumes:
      - redis:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # GHOST - CMS (Image custom)
  # ============================================
  ghost:
    build:
      context: .
      dockerfile: Dockerfile.ghost
    image: ghost-advanced:6.0
    restart: unless-stopped
    ports:
      - 2368
    environment:
      # Core
      - url=https://${GHOST_HOST}
      - NODE_ENV=production
      
      # Database
      - database__client=mysql
      - database__connection__host=db
      - database__connection__user=ghost
      - database__connection__password=${MYSQL_PASSWORD:-changeme}
      - database__connection__database=ghost
      
      # Redis Cache
      - adapters__cache__Redis__host=redis
      - adapters__cache__Redis__port=6379
      - adapters__cache__Redis__db=0
      
      # Mail SMTP
      - mail__transport=SMTP
      - mail__options__host=${MAIL_HOST}
      - mail__options__port=${MAIL_PORT:-587}
      - mail__options__auth__user=${MAIL_USER}
      - mail__options__auth__pass=${MAIL_PASSWORD}
      - mail__from=${MAIL_FROM}
      
      # Cloudflare R2 Storage (optionnel)
      - storage__active=s3-compatible
      - storage__s3-compatible__accessKeyId=${R2_ACCESS_KEY_ID}
      - storage__s3-compatible__secretAccessKey=${R2_SECRET_ACCESS_KEY}
      - storage__s3-compatible__bucket=${R2_BUCKET_NAME}
      - storage__s3-compatible__region=auto
      - storage__s3-compatible__endpoint=https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com
      - storage__s3-compatible__forcePathStyle=true
      - storage__s3-compatible__assetHost=https://${R2_PUBLIC_URL}
      
    volumes:
      - ghost:/var/lib/ghost/content
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  ghost: {}
  db: {}
  redis: {}
